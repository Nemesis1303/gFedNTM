<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.federation.client &mdash; Topic Modeler documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> gFedNTM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">gFedNTM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>src.federation.client</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.federation.client</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Feb 1, 2022</span>

<span class="sd">.. codeauthor:: L. Calvo-Bartolomé (lcalvo@pa.uc3m.es)</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">src.models.base.pytorchavitm.datasets.bow_dataset</span> <span class="kn">import</span> <span class="n">BOWDataset</span>
<span class="kn">from</span> <span class="nn">src.models.federated.federated_avitm</span> <span class="kn">import</span> <span class="n">FederatedAVITM</span>
<span class="kn">from</span> <span class="nn">src.protos</span> <span class="kn">import</span> <span class="n">federated_pb2</span><span class="p">,</span> <span class="n">federated_pb2_grpc</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">FeatureUnion</span>
<span class="kn">from</span> <span class="nn">src.utils.auxiliary_functions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">proto_to_modelStateDict</span><span class="p">,</span>
                       <span class="n">proto_to_optStateDict</span><span class="p">,</span> <span class="n">serializeTensor</span><span class="p">)</span>


<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../../src.federation.client.html#src.federation.client.Client">[docs]</a><span class="k">class</span> <span class="nc">Client</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Class containing the stubs to interact with the server-side part via a gRPC channel.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Client.__init__"><a class="viewcode-back" href="../../../src.federation.client.html#src.federation.client.Client.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">stub</span><span class="p">:</span> <span class="n">federated_pb2_grpc</span><span class="o">.</span><span class="n">FederationStub</span><span class="p">,</span>
                 <span class="n">local_corpus</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                 <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Object&#39;s initializer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : int</span>
<span class="sd">            Client&#39;s ide</span>
<span class="sd">        stub : federated_pb2_grpc.FederationStub</span>
<span class="sd">            Module acting as the interface for gRPC client</span>
<span class="sd">        local_corpus : List[str]</span>
<span class="sd">            List of documents that constitute the node&#39;s local corpus</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stub</span> <span class="o">=</span> <span class="n">stub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_corpus</span> <span class="o">=</span> \
            <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">local_corpus</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_corpus</span><span class="p">))]</span>

        <span class="c1"># Other attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_model_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_parameters</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train_data</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create logger object</span>
        <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">logging</span>
            <span class="n">FMT</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%(asctime)-15s</span><span class="s1">] [</span><span class="si">%(filename)s</span><span class="s1">] [</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">FMT</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;Client&#39;</span><span class="p">)</span>

        <span class="c1"># Send vocabulary to server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__send_local_vocab</span><span class="p">()</span>

        <span class="c1"># Wait for the consensed vocabulary and initial NN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__wait_for_agreed_vocab_NN</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__prepare_vocab_to_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the vocabulary associated to the local corpus as a dictionary object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a CountVectorizer object to convert a collection of text documents into a matrix of token counts</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="n">lowercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stop_words</span><span class="o">=</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Learn the vocabulary dictionary, bow = document-term matrix</span>
        <span class="n">cv</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_corpus</span><span class="p">)</span>
        <span class="n">vocab_dict</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">vocabulary_</span>

        <span class="k">return</span> <span class="n">vocab_dict</span>

    <span class="k">def</span> <span class="nf">__send_local_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the local vocabulary to the server and waits for its ACK.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get vocabulary to sent</span>
        <span class="n">vocab_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__prepare_vocab_to_send</span><span class="p">()</span>
        <span class="c1"># Protofy vocabulary</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">federated_pb2</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key_</span><span class="p">,</span> <span class="n">value_</span> <span class="ow">in</span> <span class="n">vocab_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dic</span><span class="o">.</span><span class="n">pairs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">federated_pb2</span><span class="o">.</span><span class="n">Dictionary</span><span class="o">.</span><span class="n">Pair</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key_</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">federated_pb2</span><span class="o">.</span><span class="n">Dictionary</span><span class="o">.</span><span class="n">Pair</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="n">ivalue</span><span class="o">=</span><span class="n">value_</span><span class="p">))])</span>

        <span class="c1"># Send dictionary to the server and wait for his response</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stub</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stub</span><span class="o">.</span><span class="n">sendLocalDic</span><span class="p">(</span><span class="n">dic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Client </span><span class="si">%s</span><span class="s1"> vocab is being sent to server.&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="c1"># Remove local file when finished the sending to the server</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">vocab_dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Server received correctly vocab from client </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__wait_for_agreed_vocab_NN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits while receiving the agreed vocabulary sent by the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Client </span><span class="si">%s</span><span class="s1"> receiving consensus vocab and initial NN.&#39;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="c1"># Get global model_parameters, model_type, dictionary and initialized NN</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stub</span><span class="o">.</span><span class="n">sendGlobalDicAndInitialNN</span><span class="p">(</span><span class="n">federated_pb2</span><span class="o">.</span><span class="n">Empty</span><span class="p">())</span>

        <span class="c1"># Unprotofy model params and model type</span>
        <span class="n">model_params_aux</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">model_params</span><span class="o">.</span><span class="n">pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;svalue&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">svalue</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="n">model_params_aux</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pair</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model_params_aux</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pair</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>  <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">svalue</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;ivalue&quot;</span><span class="p">):</span>
                <span class="n">model_params_aux</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pair</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ivalue</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;fvalue&quot;</span><span class="p">):</span>
                <span class="n">model_params_aux</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pair</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">fvalue</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;tvalue&quot;</span><span class="p">):</span>
                <span class="n">tuple_i</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">el</span><span class="o">.</span><span class="n">ivalue</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">tvalue</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
                <span class="n">model_params_aux</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pair</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">tuple_i</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;bvalue&quot;</span><span class="p">):</span>
                <span class="n">model_params_aux</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pair</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">bvalue</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">model_params_aux</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_model_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">model_type</span>

        <span class="c1"># Unprotofy global dictionary</span>
        <span class="n">vocabs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dic_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">dic</span><span class="p">)):</span>
            <span class="n">vocab_i</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">pair</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ivalue</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">dic</span><span class="p">[</span><span class="n">dic_i</span><span class="p">]</span><span class="o">.</span><span class="n">pairs</span><span class="p">])</span>
            <span class="n">cv_i</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">vocabulary</span><span class="o">=</span><span class="n">vocab_i</span><span class="p">)</span>
            <span class="n">name_i</span> <span class="o">=</span> <span class="s2">&quot;CV&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dic_i</span><span class="p">)</span>
            <span class="n">vocabs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name_i</span><span class="p">,</span> <span class="n">cv_i</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">global_vocab</span> <span class="o">=</span> <span class="n">FeatureUnion</span><span class="p">(</span><span class="n">vocabs</span><span class="p">)</span>

        <span class="c1"># Initialize local_model with initial NN</span>
        <span class="n">modelStateDict</span> <span class="o">=</span> <span class="n">proto_to_modelStateDict</span><span class="p">(</span>
            <span class="n">response</span><span class="o">.</span><span class="n">initialNN</span><span class="o">.</span><span class="n">modelUpdate</span><span class="p">)</span>
        <span class="n">optStateDict</span> <span class="o">=</span> <span class="n">proto_to_optStateDict</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">initialNN</span><span class="o">.</span><span class="n">optUpdate</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_model_type</span> <span class="o">==</span> <span class="s2">&quot;prod&quot;</span><span class="p">:</span>

            <span class="c1"># Local document-term matrix as function of the global vocabulary</span>
            <span class="n">train_bow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_vocab</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_local_corpus</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

            <span class="c1"># Array mapping from feature integer indices to feature name</span>
            <span class="n">idx2token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_vocab</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_parameters</span><span class="p">[</span><span class="s2">&quot;input_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx2token</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_parameters</span><span class="p">[</span><span class="s2">&quot;id2token&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx2token</span><span class="p">)),</span> <span class="n">idx2token</span><span class="p">)}</span>

            <span class="c1"># The train dataset is an object from the class BOWDataset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_data</span> <span class="o">=</span> <span class="n">BOWDataset</span><span class="p">(</span><span class="n">train_bow</span><span class="p">,</span> <span class="n">idx2token</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span> <span class="o">=</span> \
                <span class="n">FederatedAVITM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_parameters</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_model_type</span> <span class="o">==</span> <span class="s2">&quot;ctm&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To be implemented&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Provided underlying model not supported&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">modelStateDict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">optStateDict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Client </span><span class="si">%s</span><span class="s1"> initialized local model appropiately.&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="k">return</span>

<div class="viewcode-block" id="Client.send_per_minibatch_gradient"><a class="viewcode-back" href="../../../src.federation.client.html#src.federation.client.Client.send_per_minibatch_gradient">[docs]</a>    <span class="k">def</span> <span class="nf">send_per_minibatch_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">current_mb</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a minibatch&#39;s gradient update to the server.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        gradients : List[List[gradient_name,gradient_value]]</span>
<span class="sd">            Gradients to be sent to the server in the current minibatch</span>
<span class="sd">        current_mb: int</span>
<span class="sd">            Current minibatch, i.e. minibatch to which the gradient that is going to be sent corresponds</span>
<span class="sd">        current_epoch: int</span>
<span class="sd">            Current epoch, i.e. epoch to which the minibatch corresponds</span>
<span class="sd">        num_epochs: int</span>
<span class="sd">            Number of epochs that is going to be used for training the model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data : federated_pb2.Update</span>
<span class="sd">            Prototocol buffer that is going to be send through the gRPC channel</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Generate request&#39;s header</span>
        <span class="n">id_message</span> <span class="o">=</span> <span class="s2">&quot;ID&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">federated_pb2</span><span class="o">.</span><span class="n">MessageHeader</span><span class="p">(</span><span class="n">id_request</span><span class="o">=</span><span class="n">id_message</span><span class="p">,</span>
                                             <span class="n">message_type</span><span class="o">=</span><span class="n">federated_pb2</span><span class="o">.</span><span class="n">MessageType</span><span class="o">.</span><span class="n">CLIENT_TENSOR_SEND</span><span class="p">)</span>
        <span class="c1"># Generate request&#39;s metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> \
            <span class="n">federated_pb2</span><span class="o">.</span><span class="n">MessageAdditionalData</span><span class="p">(</span><span class="n">current_mb</span><span class="o">=</span><span class="n">current_mb</span><span class="p">,</span>
                                                <span class="n">current_epoch</span><span class="o">=</span><span class="n">current_epoch</span><span class="p">,</span>
                                                <span class="n">num_max_epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
                                                <span class="n">id_machine</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="c1"># Generate Protos Updates</span>
        <span class="n">updates_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gradient</span> <span class="ow">in</span> <span class="n">gradients</span><span class="p">:</span>
            <span class="n">tensor_protos</span> <span class="o">=</span> <span class="n">serializeTensor</span><span class="p">(</span><span class="n">gradient</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">protos_update</span> <span class="o">=</span> <span class="n">federated_pb2</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span>
                <span class="n">tensor_name</span><span class="o">=</span><span class="n">gradient</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">tensor</span><span class="o">=</span><span class="n">tensor_protos</span>
            <span class="p">)</span>
            <span class="n">updates_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">protos_update</span><span class="p">)</span>

        <span class="c1"># Generate Protos ClientTensorRequest with the update</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">federated_pb2</span><span class="o">.</span><span class="n">ClientTensorRequest</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updates_</span><span class="p">)</span>

        <span class="c1"># Send request to the server and wait for his response</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stub</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stub</span><span class="o">.</span><span class="n">sendLocalTensor</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Client </span><span class="si">%s</span><span class="s1"> received a response to request </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">response</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">id_to_request</span><span class="p">)</span></div>

<div class="viewcode-block" id="Client.listen_for_updates"><a class="viewcode-back" href="../../../src.federation.client.html#src.federation.client.Client.listen_for_updates">[docs]</a>    <span class="k">def</span> <span class="nf">listen_for_updates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for an update from the server.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        update : federated_pb2.ServerAggregatedTensorRequest</span>
<span class="sd">            Update from the server with the average tensor generated from all federation clients&#39; updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stub</span><span class="o">.</span><span class="n">sendAggregatedTensor</span><span class="p">(</span><span class="n">federated_pb2</span><span class="o">.</span><span class="n">Empty</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Client </span><span class="si">%s</span><span class="s1"> received updated for minibatch </span><span class="si">%s</span><span class="s1"> of epoch </span><span class="si">%s</span><span class="s1"> &#39;</span><span class="p">,</span>
                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span><span class="o">.</span><span class="n">current_mb</span><span class="p">),</span>
                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">update</span></div>

<div class="viewcode-block" id="Client.train_local_model"><a class="viewcode-back" href="../../../src.federation.client.html#src.federation.client.Client.train_local_model">[docs]</a>    <span class="k">def</span> <span class="nf">train_local_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trains a the local model. </span>

<span class="sd">        To do so, we send the server the gradients corresponding with the parameter beta of the model, and the server returns an update of such a parameter, which is calculated by averaging the per minibatch beta parameters that he gets from the set of clients that are connected to the federation. After obtaining the beta updates from the server, the client keeps with the training of its own local model. This process is repeated for each minibatch of each epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_train_data</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TRAINED&quot;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Client.eval_local_model"><a class="viewcode-back" href="../../../src.federation.client.html#src.federation.client.Client.eval_local_model">[docs]</a>    <span class="k">def</span> <span class="nf">eval_local_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span><span class="o">.</span><span class="n">get_results_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_model</span><span class="o">.</span><span class="n">evaluate_synthetic_model</span><span class="p">(</span>
            <span class="n">eval_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eval_params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">eval_params</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EVALUATED&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, L. Calvo-Bartolomé,  J. Arenas-García,.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>